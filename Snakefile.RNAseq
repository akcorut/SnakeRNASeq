"""
Author: Kivanc Corut
A Snakemake workflow to process RNA-Seq data.
"""

sample_id, run_id = glob_wildcards("/work/jawlab/kivanc/PeanutRnaSeq/data/fastq/{smp}_R{run}.fastq.gz")

rule all:
    input:
        expand("/scratch/ac32082/PeanutRnaSeq/FastQC/{smp}_R1_fastqc.html", smp=sample_id),
        expand("/scratch/ac32082/PeanutRnaSeq/FastQC/{smp}_R2_fastqc.html", smp=sample_id),
        "/scratch/ac32082/PeanutRnaSeq/MultiQC/fastq_multiqc.html",
        expand("/work/jawlab/kivanc/PeanutRnaSeq/data/cutadapt/{smp}_cutadapt_R1.fastq.gz", smp=sample_id),
        expand("/work/jawlab/kivanc/PeanutRnaSeq/data/cutadapt/{smp}_cutadapt_R2.fastq.gz", smp=sample_id),
        expand("/scratch/ac32082/PeanutRnaSeq/FastQCCut/{smp}_cutadapt_R1_fastqc.html", smp=sample_id),
        expand("/scratch/ac32082/PeanutRnaSeq/FastQCCut/{smp}_cutadapt_R2_fastqc.html", smp=sample_id),
        "/scratch/ac32082/PeanutRnaSeq/MultiQCCut/fastq_cutadapt_multiqc.html",
        "/scratch/ac32082/PeanutRnaSeq/trinity_assembly/Trinity.fasta"
rule fastqc:
    input:
        fwd="/work/jawlab/kivanc/PeanutRnaSeq/data/fastq/{smp}_R1.fastq.gz",
        rev="/work/jawlab/kivanc/PeanutRnaSeq/data/fastq/{smp}_R2.fastq.gz"
    output:
        html_fwd="/scratch/ac32082/PeanutRnaSeq/FastQC/{smp}_R1_fastqc.html",
        zip_fwd="/scratch/ac32082/PeanutRnaSeq/FastQC/{smp}_R1_fastqc.zip",
        html_rev="/scratch/ac32082/PeanutRnaSeq/FastQC/{smp}_R2_fastqc.html",
        zip_rev="/scratch/ac32082/PeanutRnaSeq/FastQC/{smp}_R2_fastqc.zip"
    threads:20
    log:
        log_fwd="/scratch/ac32082/PeanutRnaSeq/FastQC/logs/{smp}_R1.fastqc.log",
        log_rev="/scratch/ac32082/PeanutRnaSeq/FastQC/logs/{smp}_R2.fastqc.log"
    shell:
        """
        fastqc --outdir /scratch/ac32082/PeanutRnaSeq/FastQC -t {threads} -f fastq {input.fwd} {input.rev}
        """

rule multiqc:
    input:
        expand("/scratch/ac32082/PeanutRnaSeq/FastQC/{smp}_R1_fastqc.html", smp=sample_id),
        expand("/scratch/ac32082/PeanutRnaSeq/FastQC/{smp}_R2_fastqc.html", smp=sample_id) 
    output:
        "/scratch/ac32082/PeanutRnaSeq/MultiQC/fastq_multiqc.html"
    log:
        "/scratch/ac32082/PeanutRnaSeq/MultiQC/logs/multiqc.log"
    wrapper:
        "0.35.0/bio/multiqc"

rule cutadapt:
    input:
        r1="/work/jawlab/kivanc/PeanutRnaSeq/data/fastq/{smp}_R1.fastq.gz",
        r2="/work/jawlab/kivanc/PeanutRnaSeq/data/fastq/{smp}_R2.fastq.gz"
    output:
        r1="/work/jawlab/kivanc/PeanutRnaSeq/data/cutadapt/{smp}_cutadapt_R1.fastq.gz",
        r2="/work/jawlab/kivanc/PeanutRnaSeq/data/cutadapt/{smp}_cutadapt_R2.fastq.gz",
    log:
        "/work/jawlab/kivanc/PeanutRnaSeq/data/cutadapt/logs/{smp}.cutadapt.log"
    threads:40
    shell:
        """
        cutadapt -j {threads} -a AGATCGGAAGAGCACACGTCTGAACTCCAGTCA -A AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT -o {output.r1} -p {output.r2} {input.r1} {input.r2} &> {log}
        """

rule fastqc_after:
    input:
        fwd_trim="/work/jawlab/kivanc/PeanutRnaSeq/data/cutadapt/{smp}_cutadapt_R1.fastq.gz",
        rev_trim="/work/jawlab/kivanc/PeanutRnaSeq/data/cutadapt/{smp}_cutadapt_R2.fastq.gz"
    output:
        html_fwd_trim="/scratch/ac32082/PeanutRnaSeq/FastQCCut/{smp}_cutadapt_R1_fastqc.html",
        zip_fwd_trim="/scratch/ac32082/PeanutRnaSeq/FastQCCut/{smp}_cutadapt_R1_fastqc.zip",
        html_rev_trim="/scratch/ac32082/PeanutRnaSeq/FastQCCut/{smp}_cutadapt_R2_fastqc.html",
        zip_rev_trim="/scratch/ac32082/PeanutRnaSeq/FastQCCut/{smp}_cutadapt_R2_fastqc.zip"
    log:
        log_fwd_trim="/scratch/ac32082/PeanutRnaSeq/FastQCCut/logs/{smp}_cutadapt_R1_trim.fastqc.log",
        log_rev_trim="/scratch/ac32082/PeanutRnaSeq/FastQCCut/logs/{smp}_cutadapt_R2_trim.fastqc.log"
    threads:40
    shell:
        """
        fastqc -t {threads} {input.fwd_trim} {input.rev_trim} -q -f fastq -o /scratch/ac32082/PeanutRnaSeq/FastQCCut
        """

rule multiqc_after:
    input:
        expand("/scratch/ac32082/PeanutRnaSeq/FastQCCut/{smp}_cutadapt_R1_fastqc.html", smp=sample_id),
        expand("/scratch/ac32082/PeanutRnaSeq/FastQCCut/{smp}_cutadapt_R2_fastqc.html", smp=sample_id)
    output:
        "/scratch/ac32082/PeanutRnaSeq/MultiQCCut/fastq_cutadapt_multiqc.html"
    log:
        "/scratch/ac32082/PeanutRnaSeq/MultiQCCut/logs/multiqc_cutadapt.log"
    wrapper:
        "0.35.0/bio/multiqc"

rule trinity_assembly:
    input:
        left=[expand("/work/jawlab/kivanc/PeanutRnaSeq/data/cutadapt/{smp}_cutadapt_R1.fastq.gz", smp=sample_id)],
        right=[expand("/work/jawlab/kivanc/PeanutRnaSeq/data/cutadapt/{smp}_cutadapt_R2.fastq.gz", smp=sample_id)]
    output:
        protected("/scratch/ac32082/PeanutRnaSeq/trinity_assembly/Trinity.fasta")
    log:
        "logs/trinity/trinity.log"
    params:
        seqtype="fq",
        max_memory="200G",
        extra="--SS_lib_type RF"
    threads: 32
    wrapper:
        "0.35.0/bio/trinity"